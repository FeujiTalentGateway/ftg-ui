<div>
  <div class="header">
    <h1>{{ isEditing ? "Update Exam" : "Schedule Exam" }}</h1>
  </div>
  <!-- Schedule Exam Dialog -->
  <div class="schedule-exam-form mat-elevation-z8">
    <form [formGroup]="examForm" (ngSubmit)="onSubmit()" class="exam-form">
      <div class="form-row">
        <div>
          <label for="name">Name:</label>
          <input
            type="text"
            id="name"
            formControlName="name"
            required
            class="form-control"
            placeholder="enter exam name here"
            aria-label="Exam Name"
          />

          <div
            *ngIf="
              examForm.get('name')?.hasError('required') &&
              examForm.get('name')?.touched
            "
            class="error-msg"
          >
            Name is required.
          </div>
          <div
            *ngIf="
              examForm.get('name')?.hasError('maxlength') &&
              examForm.get('name')?.touched
            "
            class="error-msg"
          >
            Maximum length is 255 characters.
          </div>
        </div>

        <div>
          <label for="examCode">Exam Code:</label>
          <input
            type="text"
            id="examCode"
            formControlName="examCode"
            required
            class="form-control"
            placeholder="enter exam code here"
          />
          <div
            *ngIf="
              examForm.get('examCode')?.hasError('required') &&
              examForm.get('examCode')?.touched
            "
            class="error-msg"
          >
            Exam Code is required.
          </div>
          <div
            *ngIf="
              examForm.get('examCode')?.hasError('maxlength') &&
              examForm.get('examCode')?.touched
            "
            class="error-msg"
          >
            Maximum length is 50 characters.
          </div>
        </div>

        <div>
          <label for="duration">Exam Duration:</label>
          <input
            type="text"
            readonly
            id="duration"
            formControlName="duration"
            required
            class="form-control"
            placeholder="HH:mm:ss"
          />
          <div
            *ngIf="
              examForm.get('duration')?.hasError('required') &&
              examForm.get('duration')?.touched
            "
            class="error-msg"
          >
            Duration is required.
          </div>
          <div
            *ngIf="
              examForm.get('duration')?.hasError('pattern') &&
              examForm.get('duration')?.touched
            "
            class="error-msg"
          >
            Duration should be in the format HH:mm:ss.
          </div>
        </div>
        <div>
          <label for="startDate">Start Date:</label>
          <input
            type="date"
            id="startDate"
            formControlName="startDate"
            required
            class="form-control"
            [min]="minStartDate"
          />

          <div
            *ngIf="
              examForm.get('startDate')?.hasError('required') &&
              examForm.get('startDate')?.touched
            "
            class="error-msg"
          >
            Start Date is required.
          </div>

          <div
            *ngIf="
              examForm.get('startDate')?.hasError('dateRange') &&
              examForm.get('startDate')?.touched
            "
            class="error-msg"
          >
            {{ examForm.get("startDate")?.getError("dateRange") }}
          </div>
        </div>

        <div>
          <label for="endDate">End Date:</label>
          <input
            type="date"
            id="endDate"
            formControlName="endDate"
            required
            class="form-control"
            [min]="minStartDate"
          />

          <div
            *ngIf="
              examForm.get('endDate')?.hasError('required') &&
              examForm.get('endDate')?.touched
            "
            class="error-msg"
          >
            End Date is required.
          </div>
          <div *ngIf="examForm.hasError('dateRange')" class="error-msg">
            End Date must be greater than Start Date
          </div>

          <div
            *ngIf="
              examForm.get('endDate')?.hasError('dateRange') &&
              examForm.get('endDate')?.touched
            "
            class="error-msg"
          >
            {{ examForm.get("endDate")?.getError("dateRange") }}
          </div>
        </div>

        <!-- Inside your form -->
        <div class="active">
          <div></div>
          <div>
            <label for="active">Active:</label> &nbsp; &nbsp;
            <mat-slide-toggle
              color="warn"
              id="active"
              formControlName="active"
            ></mat-slide-toggle>
          </div>
        </div>
        <div></div>
      </div>
      <div>
        <label for="description">Description:</label>
        <textarea
          id="description"
          formControlName="description"
          required
          class="form-control"
          placeholder="enter exam description here"
        ></textarea>
        <div
          *ngIf="
            examForm.get('description')?.hasError('required') &&
            examForm.get('description')?.touched
          "
          class="error-msg"
        >
          Description is required.
        </div>
        <div
          *ngIf="
            examForm.get('description')?.hasError('maxlength') &&
            examForm.get('description')?.touched
          "
          class="error-msg"
        >
          Maximum length is 255 characters.
        </div>
      </div>

      <div class="subject-list">
        <label for="subjectControl">Select Subjects</label>
        <mat-select
          multiple
          id="subjectControl"
          required
          class="form-control"
          [ngModelOptions]="{ standalone: true }"
          [(ngModel)]="selectedSubjectIds"
          (selectionChange)="onSubjectSelected()"
          #subjectControl="ngModel"
        >
          <!-- <mat-option [value]="null">Select Any Subject</mat-option> -->
          <mat-option *ngFor="let subject of subjects" [value]="subject.id">{{
            subject.name
          }}</mat-option>
        </mat-select>
        <div *ngIf="subjectControl.touched && !isValid()" class="error-msg">
          At least one subject is required.
        </div>
      </div>

      <ng-container
        formArrayName="examSubjects"
        *ngFor="let subjectGroup of getExamSubjectsControls(); let i = index"
      >
        <div [formGroupName]="i" class="exam-subject-item">
          <div>
            <label for="subjectName{{ i }}">Subject Name</label>
            <input
              id="subjectName{{ i }}"
              readonly
              formControlName="subjectName"
              class="form-control"
            />
          </div>

          <div>
            <label for="maxQuestions{{ i }}">Max Questions</label>
            <mat-select
              id="maxQuestions{{ i }}"
              formControlName="maxQuestions"
              class="form-control"
            >
              <mat-option
                *ngFor="let count of maxQuestionsArray"
                [value]="count"
                >{{ count }}</mat-option
              >
            </mat-select>
            <div
              *ngIf="
                subjectGroup.get('maxQuestions')?.hasError('required') &&
                subjectGroup.get('maxQuestions')?.touched
              "
              class="error-msg"
            >
              Max Questions is required.
            </div>
          </div>

          <div>
            <label for="startingDifficultyLevel{{ i }}"
              >Starting Difficulty Level</label
            >
            <mat-select
              id="startingDifficultyLevel{{ i }}"
              formControlName="startingDifficultyLevel"
              class="form-control"
            >
              <!-- <mat-option [value]="null">Select Any Subject</mat-option> -->
              <mat-option
                *ngFor="let difficultyLevel of difficultyLevelArray"
                [value]="difficultyLevel"
                >{{ difficultyLevel }}</mat-option
              >
            </mat-select>
            <div
              *ngIf="
                subjectGroup
                  .get('startingDifficultyLevel')
                  ?.hasError('required') &&
                subjectGroup.get('startingDifficultyLevel')?.touched
              "
              class="error-msg"
            >
              Strting Difficulty Level is required.
            </div>
            <!-- <input id="startingDifficultyLevel{{i}}" formControlName="startingDifficultyLevel" class="form-control" /> -->
          </div>
          <div>
            <!-- <label for="duration{{ i }}">Duration</label>
            <input
              id="duration{{ i }}"
              formControlName="duration"
              (change)="updateExamDuration()"
              class="form-control"
            />
            <div
              *ngIf="
                subjectGroup.get('duration')?.hasError('required') &&
                subjectGroup.get('duration')?.touched
              "
              class="error-msg"
            >
              Duration is required.
            </div>
            <div
              *ngIf="
                subjectGroup.get('duration')?.hasError('pattern') &&
                subjectGroup.get('duration')?.touched
              "
              class="error-msg"
            >
              Duration should be in the format HH:mm:ss.
            </div> -->
            <label for="duration">Duration</label>
            <div
              class="d-flex align-item-center justify-content-even flex-dir-column form-control"
            >
              <div>
                <!-- <label for="hours{{ i }}">:</label> -->
                <select
                  id="hours{{ i }}"
                  formControlName="hours"
                  class="sub-duration"
                  (change)="mapSubDurationToDuration()"
                >
                  <option *ngFor="let hour of hoursArray" [value]="hour">
                    {{ hour }}
                  </option>
                </select>
              </div>

              <div>
                <label for="minutes{{ i }}">:</label>
                <select
                  id="minutes{{ i }}"
                  formControlName="minutes"
                  class="sub-duration"
                  (change)="mapSubDurationToDuration()"
                >
                  <option *ngFor="let minute of minutesArray" [value]="minute">
                    {{ minute }}
                  </option>
                </select>
              </div>

              <div>
                <label for="seconds{{ i }}">:</label>
                <select
                  id="seconds{{ i }}"
                  formControlName="seconds"
                  class="sub-duration"
                  (change)="mapSubDurationToDuration()"
                >
                  <option *ngFor="let second of secondsArray" [value]="second">
                    {{ second }}
                  </option>
                </select>
              </div>
            </div>
          </div>
          <button
            class="btn btn-outline-secondary remove-subject"
            type="button"
            pInputText
            pTooltip="Remove Option"
            (click)="removeExamSubject(i)"
            tooltipPosition="bottom"
          >
            <mat-icon aria-hidden="false" color="red" aria-label="Remove icon"
              >clear</mat-icon
            >
          </button>

          <!-- Add other form controls for the subject as needed -->
        </div>
      </ng-container>
      <button
        mat-raised-button
        color="warn"
        class="add-user"
        (click)="addUsers($event)"
      >
        {{ isEditing ? "Update Users" : "Add Users" }}
      </button>

      <button
        mat-raised-button
        color="primary"
        class="submit-btn mb-4 mt-2"
        [disabled]="examForm.invalid"
        type="submit"
      >
        {{ isEditing ? "Update Exam" : "Schedule Exam" }}
      </button>
    </form>
  </div>
</div>
